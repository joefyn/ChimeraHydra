{
    "title":  "codex.instructions.json schema",
    "type":  "object",
    "additionalProperties":  false,
    "required":  [
                     "run_id",
                     "ops"
                 ],
    "properties":  {
                       "run_id":  {
                                      "type":  "string",
                                      "minLength":  6
                                  },
                       "ts":  {
                                  "type":  "string",
                                  "format":  "date-time"
                              },
                       "model":  {
                                     "type":  "string"
                                 },
                       "tools":  {
                                     "type":  "array",
                                     "items":  {
                                                   "type":  "string"
                                               }
                                 },
                       "ops":  {
                                   "type":  "array",
                                   "minItems":  1,
                                   "items":  {
                                                 "type":  "object",
                                                 "additionalProperties":  false,
                                                 "required":  [
                                                                  "selector",
                                                                  "op"
                                                              ],
                                                 "properties":  {
                                                                    "id":  {
                                                                               "type":  "string"
                                                                           },
                                                                    "selector":  {
                                                                                     "type":  "object",
                                                                                     "additionalProperties":  false,
                                                                                     "required":  [
                                                                                                      "file",
                                                                                                      "expect_sha"
                                                                                                  ],
                                                                                     "properties":  {
                                                                                                        "file":  {
                                                                                                                     "type":  "string"
                                                                                                                 },
                                                                                                        "expect_sha":  {
                                                                                                                           "type":  "string",
                                                                                                                           "pattern":  "^[0-9a-fA-F]{40}$"
                                                                                                                       },
                                                                                                        "kind":  {
                                                                                                                     "type":  "string",
                                                                                                                     "enum":  [
                                                                                                                                  "anchor",
                                                                                                                                  "symbol",
                                                                                                                                  "line_range"
                                                                                                                              ]
                                                                                                                 },
                                                                                                        "anchor":  {
                                                                                                                       "type":  "string"
                                                                                                                   },
                                                                                                        "symbol":  {
                                                                                                                       "type":  "string"
                                                                                                                   },
                                                                                                        "lang":  {
                                                                                                                     "type":  "string"
                                                                                                                 },
                                                                                                        "line_range":  {
                                                                                                                           "type":  "object",
                                                                                                                           "additionalProperties":  false,
                                                                                                                           "required":  [
                                                                                                                                            "start",
                                                                                                                                            "end"
                                                                                                                                        ],
                                                                                                                           "properties":  {
                                                                                                                                              "start":  {
                                                                                                                                                            "type":  "integer",
                                                                                                                                                            "minimum":  1
                                                                                                                                                        },
                                                                                                                                              "end":  {
                                                                                                                                                          "type":  "integer",
                                                                                                                                                          "minimum":  1
                                                                                                                                                      }
                                                                                                                                          }
                                                                                                                       }
                                                                                                    }
                                                                                 },
                                                                    "op":  {
                                                                               "type":  "string",
                                                                               "enum":  [
                                                                                            "insert",
                                                                                            "replace",
                                                                                            "delete"
                                                                                        ]
                                                                           },
                                                                    "content":  {
                                                                                    "type":  "string"
                                                                                },
                                                                    "assertions":  {
                                                                                       "type":  "object",
                                                                                       "additionalProperties":  false,
                                                                                       "properties":  {
                                                                                                          "selector_order":  {
                                                                                                                                 "type":  "array",
                                                                                                                                 "items":  {
                                                                                                                                               "type":  "string",
                                                                                                                                               "enum":  [
                                                                                                                                                            "anchor",
                                                                                                                                                            "symbol",
                                                                                                                                                            "line_range"
                                                                                                                                                        ]
                                                                                                                                           }
                                                                                                                             },
                                                                                                          "glossary_ok":  {
                                                                                                                              "type":  "boolean"
                                                                                                                          },
                                                                                                          "abort_on_miss":  {
                                                                                                                                "type":  "boolean"
                                                                                                                            }
                                                                                                      }
                                                                                   }
                                                                },
                                                 "allOf":  [
                                                               {
                                                                   "if":  {
                                                                              "properties":  {
                                                                                                 "op":  {
                                                                                                            "const":  "delete"
                                                                                                        }
                                                                                             }
                                                                          },
                                                                   "then":  {
                                                                                "not":  {
                                                                                            "required":  [
                                                                                                             "content"
                                                                                                         ]
                                                                                        }
                                                                            }
                                                               },
                                                               {
                                                                   "if":  {
                                                                              "properties":  {
                                                                                                 "op":  {
                                                                                                            "enum":  [
                                                                                                                         "insert",
                                                                                                                         "replace"
                                                                                                                     ]
                                                                                                        }
                                                                                             }
                                                                          },
                                                                   "then":  {
                                                                                "required":  [
                                                                                                 "content"
                                                                                             ]
                                                                            }
                                                               }
                                                           ]
                                             }
                               }
                   },
    "$schema":  "https://json-schema.org/draft/2020-12/schema",
    "$id":  "https://joefyn.github.io/ChimeraHydra/schemas/codex.instructions.schema.json"
}
